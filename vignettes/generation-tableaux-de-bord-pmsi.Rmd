---
title: "Génération de tableaux de bord PMSI avec pmeasyr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{generation-tableaux-de-bord-pmsi}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE,
  echo = TRUE,
  warning=FALSE,
  results = 'markup'
)
```

```{r setup}
library(dimRactivite)
library(pmeasyr)
library(tidyverse)
library (RCurl)
library(jsonlite)
library(referentiels)
library(referime)
```

# Import des données dans R

### Paramètre des imports
Le paramètres nécessaires pour les imports se trouvent dans un le fichier options.yaml (cf exemple)
```{r profondeur}
dimRactivite:::update_options("options.yaml")

profondeur_imports = 2
```
### Création des fichiers .RData par remontée

La première étape est de scanner le dossier contenant les archives afin de dresser la liste de remontées disponibles.

#### Liste des fichiers présents dans le dossier racine
```{r scan_path}
fichiers_genrsa <- dimRactivite:::scan_path()
```

#### Analyse des fichiers et vérification de la présence des fichiers en fonction de leur extentions (ext imco + .zip + .RData)

Les fichiers sont ensuite analysés afin de préparer la création (ou non) des fichiers .RData. On vérifie la présence dans les fichiers zippés en sortie de GENRSA de l'ensemble des fichiers nécessaires à la facturation et à l'analyse de l'activité en lisant l'extension des fichiers de l'archive.

```{r analyse_fichier_remontees}
remontees_dispo <- dimRactivite:::analyse_fichiers_remontees(fichiers_genrsa)

remontees_dispo%>%arrange(annee,mois,finess)
```

#### Création et sauvegarde des .RData de remontée (si manquant) et mise à jour de la liste des remontées disponibles

La fonction ``` save_remontee``` prend comme argument le tableau de synthèse des fichiers diponibles dans le dossier racine et produit jun .RData par remontée qui est enregisté dans le dossier racine. Pour être importée, une remontée doit comprendre le in et le out de GENRSA. Les fichiers indispensables sont le .rss et le .rsa. S'ils ne sont pas présents dans l'archive les autres fichiers seront générés automatiquement (fichier vide).Les remontées pour lequelles un fichier .RData est disponible ne seront pas ré-importés.

Par défaut, l'option ```option recent = TRUE ``` induit la création du .RData pour la dernière remontée disponible en forçant la variable .RData du df remontees_dispo à 0 (même si un fichier .RData est disponible pour cette remontée dans le dossier racine).


```{r save_remontee}
#remontees_dispo <- dimRactivite:::save_remontees( remontees_dispo, fichiers_genrsa )
```


#### Sélection des remontées à importer dans R
Les données peuvent ensuite être importées dans la mémoire de R. Par défaut on choisit le M12 des années antérieures et le dernier mois pour l'année en cours.

```{r sel_remontees_import}
sel_remontees_import<-remontees_dispo%>%filter(as.numeric(annee)> max(as.numeric(remontees_dispo$annee))-profondeur_imports, RData==1)%>%
  group_by(finess,annee)%>%summarise(mois = max(as.numeric(mois)))

sel_remontees_import
```
Le df ```sel_remontees_import``` est passé en argument de la fonction ``` load_all()``` qui permet le chargment des données.

```{r load_all}
dimRactivite:::load_all(sel_remontees_import%>%filter(as.numeric(annee) > max(as.numeric(sel_remontees_import$annee))-profondeur_imports))
table(rsa$nofiness,rsa$ansor)
```

#### Ajout des données de struture

Différentes données complémentaires peuvent ensuite est ajoutées aux données PMSI standardisées. Problement la plus importante d'entre elles, est l'ajout d'élements descriptifs des uma : leur libellé, services et pôles de rattachement. L'ajout des structures se fait grâce à un fichier de paramètre ``` structure.xls``` (cf exemple).

La fonction ```verif_structure()``` permet de s'assurer que l'ensemble des uma présentes dans les fichiers GENRSA sont bien renseignées dans le fichier structure.

```{r Chargement du fichier structure}

fichier_structure <- readxl::read_excel("structures.xlsx",
                                        col_types = c( "text" , "text" , "text" , "text" ,"text" ,
                                                       "text" , "text" , "text" , "text" ),
                                        col_names = c('nofiness','hopital','cdurm','uma_locale','uma_locale2',
                                                      'libelle_um','service','regroupement1','pole'),
                                        skip = 1
)

dimRactivite:::verif_structure(rum,fichier_structure)

rum <- rum %>% left_join( ., fichier_structure ) %>%
           mutate(pole = ifelse(is.na(pole),'Erreurs',pole),
           service = ifelse(is.na(service),'Erreur service non renseigné',service))

```

On pourrait à cet endroit, vouloir également ajouter d'autres informations sur les RUM comme par exemple l'identité des patients.

# Génération des tableaux de bord

Deux types de tableaux de bord peuvent être générés :
- des tableaux synthétiques permettant une vue de l'évolution temporelle d'un indicateur pour l'ensmeble de l'établissement ou du groupe hospitalier
- des tableaux détaillés pour chaque niveau du fichier structure permettant de suivre l'évolution temporalle pour ce niveau d'un ensemble d'indicateurs prédéfinis

Pour l'ensemble de ces tableaux on produit une version mensuelle et une version cumulée. La fonction ``` get_data() ``` permet de préparer les données.

### Paramètres des tableaux de bord

Pour les tableaux détaillés, un fichier de paramétrage permet de définir quels indicateurs calculer pour chaque élément du fichier structure (par ex. le suivi de l'activité des services de réanimation nécessitera le suivi d'indicateurs différents que ceux des services de médecine). Sachant que le nombre d'indicateurs calculés aujourd'hui est important (de l'ordre de 200) nous avons également laisser la possibilité de découper les résultats en différents tableaux.

L'option ``` profondeur_tdb ``` permet de définir la profondeur temporelle, en année, du suivi des tableaux de bord. D'autres données de références sont également utiles commes les dms de référence dans la base nationale pmsi ou des liste de disgnostics. Elles sont chargées grâce aux package ```referime```` et ```referentiel```.

```{r Chargement du annee mois en cours}

#Chemins pour les sorties écriture des fichiers de sortie
path_res = getwd()

#Année et mois en cours
mois=as.numeric(format(Sys.Date()-50,'%m'));Mois=format(Sys.Date()-50,'%m')
annee=as.numeric(format(Sys.Date()-55,'%Y'))

#Profondeur de calcul
profondeur_tdb = 2

#### Import des paramètres des tableaux 
ghm_dms_nationales<-referime::get_table("ghm_dms_nationales")

#Merge rsa, dms pour les cas ou la référence dans ghm_dms_nationales = ghs
rsa_dms1<-inner_join(rsa%>%unite("ghm",gpcmd,gptype,gpnum,gpcompx,sep="")%>%
                       rename(ghs = noghs)%>%
                       select(nofiness,cle_rsa,ansor,anseqta,ghs,ghm),
                     ghm_dms_nationales%>%filter(ghs!=""))
#Merge rsa, dms pour les cas ou la référence dans ghm_dms_nationales = ghm
rsa_dms2<-inner_join(rsa%>%unite("ghm",gpcmd,gptype,gpnum,gpcompx,sep="")%>%
                       select(nofiness,cle_rsa,ansor,anseqta,ghm),
                     ghm_dms_nationales%>%filter(ghs==""))
rsa_dms<-bind_rows(rsa_dms1%>%select(nofiness,cle_rsa,ansor,dms_n),
                   rsa_dms2%>%select(nofiness,cle_rsa,ansor,dms_n)
                   )
rm(rsa_dms1,rsa_dms2) 


#### Import des paramètres (liste des indicateurs à calculer pour chaque niveau du fichier structure)
references<-read.table('indicateurs.xls',
                       sep='\t',
                       header=F,fill=T,
                       na.strings = c("NA",""),stringsAsFactor=F,fileEncoding = 'latin1')

names(references)<-dimRactivite:::prep_string(references[1,])
references<-references[-1,]%>%as_tibble(.)
#labels = df simple avec les légendes
labels<-as.data.frame(references[!duplicated(references$var),c('var','libelle','niv')])
row.names(labels)<-labels$var
labels<-labels[,-1]

#Présents dans fichiers structure, absent référentiels
#dimRactivite:::prep_string(str)[!dimRactivite:::prep_string(str)%in%names(references)]
#Présents référentiels, absents fichier structure
#names(references)[!names(references)%in%c(dimRactivite:::prep_string(str),'tdb','niv','libelle','var','variable','dataframe','referentiel')]


#####################################################################################################################
#Prération des données pour le suivi de l'activité de cancérologie
#####################################################################################################################
cancer_diag <- dimRactivite:::selection_cancer_diag(diagnostics)
cancer_pat <- dimRactivite:::selection_cancer_pat(cancer_diag , vano%>%inner_join(., rum%>%select(nofiness,cle_rsa,ansor,nas)) %>%
                                     select( nas, noanon ) %>%
                                     distinct(nas,noanon))
cancer_rsa <- dplyr::inner_join(cancer_pat,
                                rsa%>%inner_join(., vano%>%select(nofiness,cle_rsa,ansor,noanon))%>%
                                  select(noanon,nofiness,cle_rsa,ansor, moissor, nas, dp, gpcmd, gptype, gpnum, gpcompx))%>%
  dimRactivite:::attribution_type_M4(.)%>%
  dimRactivite:::attribution_statut_nx_patient(.)


```


### Génération des tableaux de bord synthétiques

```{r tableaux de bord synthetiques }

df<-dimRactivite:::get_data(inner_join(rum,rum_v), a =(annee-profondeur_tdb):annee, m = 1:mois )


tdb <- dimRactivite:::get_activite_sejours( df, structure )
path_file=paste0('TableauDeBordGeneral',annee,stringr::str_pad(mois,2,"left","0"),'cum.xls')  
write.table( tdb, file=path_file, sep='\t', row.names=T, col.names=NA, na='' , fileEncoding = "utf-8" )

tdb <- dimRactivite:::get_activite_recettes( df, structure )
path_file=paste0('TableauDeBordValorisation',annee,stringr::str_pad(mois,2,"left","0"),'cum.xls')  
write.table( tdb, file=path_file, sep='\t', row.names=T, col.names=NA, na='' , fileEncoding = "utf-8" )


df <- df %>% filter( as.numeric(moissor) == mois )

tdb <- dimRactivite:::get_activite_sejours( df, structure )
path_file=paste0('TableauDeBordGeneral',annee,stringr::str_pad(mois,2,"left","0"),'mens.xls')  
write.table( tdb, file=path_file, sep='\t', row.names=T, col.names=NA, na='' , fileEncoding = "utf-8" )

tdb <- dimRactivite:::get_activite_recettes( df, structure )
path_file=paste0('TableauDeBordValorisation',annee,stringr::str_pad(mois,2,"left","0"),'mens.xls')  
write.table( tdb, file=path_file, sep='\t', row.names=T, col.names=NA, na='' , fileEncoding = "utf-8" )


``` 


### Génération des tableaux de bord détaillés

```{r tableaux de bord détaillés}
tdb<-list()
#######################################################################################################################
#Tableaux de bords thématiques
#######################################################################################################################
niveau = "hopital"
vals = fichier_structure%>%select(!!niveau)%>%unique()%>%flatten_chr()

for (val in vals ){
  
  #tdb[[val]]<-dimRactivite:::make_tdb( val, niveau, annee, mois )
  
}


niveau = "pole"
vals = fichier_structure%>%select(!!niveau)%>%unique()%>%flatten_chr()

for (val in vals ){
  
  #tdb[[val]]<-dimRactivite:::make_tdb( val, niveau, annee, mois )
  
}


#niveau = "service"
vals = fichier_structure%>%select(!!niveau)%>%unique()%>%flatten_chr()

for ( val in vals ){
  
#  tdb[[val]]<-make_tdb( val, niveau, annee, mois )
  
}


```


