<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Génération de tableaux de bord PMSI avec pmeasyr • dimRactivite</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Génération de tableaux de bord PMSI avec pmeasyr">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dimRactivite</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/generation-tableaux-de-bord-pmsi.html">Génération de tableaux de bord PMSI avec pmeasyr</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Génération de tableaux de bord PMSI avec pmeasyr</h1>
            
      
      
      <div class="hidden name"><code>generation-tableaux-de-bord-pmsi.Rmd</code></div>

    </div>

    
    
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dimRactivite)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(pmeasyr)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyverse)
<span class="co">#&gt; ── Attaching packages ─────────────────────────────────────────────── tidyverse 1.2.1 ──</span>
<span class="co">#&gt; ✔ ggplot2 3.2.1.9000     ✔ purrr   0.3.2     </span>
<span class="co">#&gt; ✔ tibble  2.1.3          ✔ dplyr   0.8.3     </span>
<span class="co">#&gt; ✔ tidyr   0.8.3          ✔ stringr 1.4.0     </span>
<span class="co">#&gt; ✔ readr   1.3.1          ✔ forcats 0.4.0</span>
<span class="co">#&gt; ── Conflicts ────────────────────────────────────────────────── tidyverse_conflicts() ──</span>
<span class="co">#&gt; ✖ dplyr::filter() masks stats::filter()</span>
<span class="co">#&gt; ✖ dplyr::lag()    masks stats::lag()</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span> (RCurl)
<span class="co">#&gt; Le chargement a nécessité le package : bitops</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attachement du package : 'RCurl'</span>
<span class="co">#&gt; The following object is masked from 'package:tidyr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     complete</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(jsonlite)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attachement du package : 'jsonlite'</span>
<span class="co">#&gt; The following object is masked from 'package:purrr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     flatten</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(referentiels)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(referime)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(readxl)</code></pre></div>
<div id="import-des-donnees-dans-r" class="section level1">
<h1 class="hasAnchor">
<a href="#import-des-donnees-dans-r" class="anchor"></a>Import des données dans R</h1>
<div id="parametre-des-imports" class="section level3">
<h3 class="hasAnchor">
<a href="#parametre-des-imports" class="anchor"></a>Paramètre des imports</h3>
<p>Le paramètres nécessaires pour les imports se trouvent dans un le fichier options.yaml (cf exemple) en particulier la variable <code>path</code> qui donne le chemin du dossier racine dans le quel se trouve les archives PMSI en sortie de GENRSA.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/update_options.html">update_options</a></span>(<span class="st">"options.yaml"</span>)

profondeur_imports =<span class="st"> </span><span class="dv">2</span></code></pre></div>
</div>
<div id="creation-des-fichiers--rdata-par-remontee" class="section level3">
<h3 class="hasAnchor">
<a href="#creation-des-fichiers--rdata-par-remontee" class="anchor"></a>Création des fichiers .RData par remontée</h3>
<p>La première étape consiste à scanner le dossier contenant les archives afin de dresser la liste de remontées disponibles ce qui produit un tableaux de données référençant l’ensemble des informations utiles sur les archives et leur contenu. Ce tableau appelé <code>fichiers_genrsa</code> sera utilisé par les autres fonctions d’imports comme reférentiel pour décrire les données disponibles.</p>
<div id="liste-des-fichiers-presents-dans-le-dossier-racine" class="section level4">
<h4 class="hasAnchor">
<a href="#liste-des-fichiers-presents-dans-le-dossier-racine" class="anchor"></a>Liste des fichiers présents dans le dossier racine</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fichiers_genrsa &lt;-<span class="st"> </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/scan_path.html">scan_path</a></span>()</code></pre></div>
</div>
<div id="analyse-des-fichiers-et-verification-de-la-presence-des-fichiers-en-fonction-de-leur-extentions-ext-imco--zip--rdata" class="section level4">
<h4 class="hasAnchor">
<a href="#analyse-des-fichiers-et-verification-de-la-presence-des-fichiers-en-fonction-de-leur-extentions-ext-imco--zip--rdata" class="anchor"></a>Analyse des fichiers et vérification de la présence des fichiers en fonction de leur extentions (ext imco + .zip + .RData)</h4>
<p>Les fichiers sont ensuite analysés afin de préparer la création (ou non) des fichiers .RData. On vérifie la présence dans les fichiers zippés en entrée et en sortie de GENRSA de l’ensemble des fichiers nécessaires à la facturation et à l’analyse de l’activité en lisant l’extension des fichiers de l’archive. Ce second tableau de données plus synthétique servira également de base pour les autres fonctions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">remontees_dispo &lt;-<span class="st"> </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/analyse_fichiers_remontees.html">analyse_fichiers_remontees</a></span>(fichiers_genrsa)

remontees_dispo<span class="op">%&gt;%</span><span class="kw">arrange</span>(annee,mois,finess)
<span class="co">#&gt; # A tibble: 92 x 13</span>
<span class="co">#&gt;    finess annee mois    rss   rsa   tra   ano   ium  diap  porg   pie</span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1 75010… 2013  12        1     1     1     1     1     1     1     0</span>
<span class="co">#&gt;  2 75010… 2013  12        1     1     1     1     1     1     1     0</span>
<span class="co">#&gt;  3 75010… 2014  12        1     1     1     1     1     1     1     0</span>
<span class="co">#&gt;  4 75010… 2014  12        1     1     1     1     1     1     1     0</span>
<span class="co">#&gt;  5 75010… 2015  12        1     1     1     1     1     1     1     0</span>
<span class="co">#&gt;  6 75010… 2015  12        1     1     1     1     1     1     1     0</span>
<span class="co">#&gt;  7 75010… 2016  1         1     1     1     1     1     1     1     0</span>
<span class="co">#&gt;  8 75010… 2016  1         1     1     1     1     1     1     1     0</span>
<span class="co">#&gt;  9 75010… 2016  10        1     1     1     1     1     1     1     0</span>
<span class="co">#&gt; 10 75010… 2016  10        1     1     1     1     1     1     1     0</span>
<span class="co">#&gt; # … with 82 more rows, and 2 more variables: manquants &lt;dbl&gt;, RData &lt;dbl&gt;</span></code></pre></div>
</div>
<div id="creation-et-sauvegarde-des--rdata-de-remontee-si-manquant-et-mise-a-jour-de-la-liste-des-remontees-disponibles" class="section level4">
<h4 class="hasAnchor">
<a href="#creation-et-sauvegarde-des--rdata-de-remontee-si-manquant-et-mise-a-jour-de-la-liste-des-remontees-disponibles" class="anchor"></a>Création et sauvegarde des .RData de remontée (si manquant) et mise à jour de la liste des remontées disponibles</h4>
<p>La fonction <code>save_remontee</code> prend comme argument le tableau de synthèse des fichiers diponibles dans le dossier racine et produit un fichier .RData pour chaque remontée, qui est enregisté dans le dossier racine. Pour être importée, une remontée doit comprendre le in et le out de GENRSA. Les fichiers indispensables sont le .rss et le .rsa. S’ils ne sont pas présents dans l’archive les autres fichiers seront générés automatiquement (fichier vide). Les remontées pour lequelles un fichier .RData est disponible ne seront pas ré-importés.</p>
<p>Par défaut, l’option <code>option recent = TRUE</code> induit la création du .RData pour la dernière remontée disponible en forçant la variable .RData du tableau de données <code>remontees_dispo</code> à 0 (même si un fichier .RData est disponible pour cette remontée dans le dossier racine).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#remontees_dispo &lt;- dimRactivite:::save_remontees( remontees_dispo, fichiers_genrsa )</span></code></pre></div>
</div>
<div id="selection-des-remontees-a-importer-dans-r" class="section level4">
<h4 class="hasAnchor">
<a href="#selection-des-remontees-a-importer-dans-r" class="anchor"></a>Sélection des remontées à importer dans R</h4>
<p>Les données peuvent ensuite être importées dans la mémoire de R. Par défaut on choisit le M12 des années antérieures et le dernier mois pour l’année en cours.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sel_remontees_import&lt;-remontees_dispo<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(annee)<span class="op">&gt;</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(remontees_dispo<span class="op">$</span>annee))<span class="op">-</span>profondeur_imports, RData<span class="op">==</span><span class="dv">1</span>)<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(finess,annee)<span class="op">%&gt;%</span><span class="kw">summarise</span>(<span class="dt">mois =</span> <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(mois)))

sel_remontees_import
<span class="co">#&gt; # A tibble: 4 x 3</span>
<span class="co">#&gt; # Groups:   finess [2]</span>
<span class="co">#&gt;   finess    annee  mois</span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 750100042 2018     12</span>
<span class="co">#&gt; 2 750100042 2019      6</span>
<span class="co">#&gt; 3 750100075 2018     12</span>
<span class="co">#&gt; 4 750100075 2019      6</span></code></pre></div>
<p>Le df <code>sel_remontees_import</code> est passé en argument de la fonction <code><a href="../reference/load_all.html">load_all()</a></code> qui permet le chargment des données.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/load_all.html">load_all</a></span>(sel_remontees_import<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(annee) <span class="op">&gt;</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(sel_remontees_import<span class="op">$</span>annee))<span class="op">-</span>profondeur_imports))
<span class="co">#&gt; </span>
<span class="co">#&gt;  Importés dans l'espace de travail :annees : 2018/2019rsa, rsa_v  : 230619 lignes </span>
<span class="co">#&gt; rum, rum_v :260354 lignes</span>
<span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(rsa<span class="op">$</span>nofiness,rsa<span class="op">$</span>ansor)
<span class="co">#&gt;            </span>
<span class="co">#&gt;               2018   2019</span>
<span class="co">#&gt;   750100042  46646  23923</span>
<span class="co">#&gt;   750100075 106833  53217</span></code></pre></div>
</div>
<div id="ajout-des-donnees-de-struture" class="section level4">
<h4 class="hasAnchor">
<a href="#ajout-des-donnees-de-struture" class="anchor"></a>Ajout des données de struture</h4>
<p>Différentes données complémentaires peuvent ensuite est ajoutées aux données PMSI standardisées. L’ajout d’élements descriptifs des uma (leur libellé, services et pôles de rattachement) sera probablement la plus important d’entre elles. L’ajout des structures se fait grâce à un fichier de paramètre <code>structure.xls</code> (cf exemple).</p>
<p>La fonction <code><a href="../reference/verif_structure.html">verif_structure()</a></code> permet de s’assurer que l’ensemble des uma présentes dans les fichiers GENRSA sont bien renseignées dans le fichier structure.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
fichier_structure &lt;-<span class="st"> </span>readxl<span class="op">::</span><span class="kw"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span>(<span class="st">"structures.xlsx"</span>,
                                        <span class="dt">col_types =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>( <span class="st">"text"</span> , <span class="st">"text"</span> , <span class="st">"text"</span> , <span class="st">"text"</span> ,<span class="st">"text"</span> ,
                                                       <span class="st">"text"</span> , <span class="st">"text"</span> , <span class="st">"text"</span> , <span class="st">"text"</span> ),
                                        <span class="dt">col_names =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'nofiness'</span>,<span class="st">'hopital'</span>,<span class="st">'cdurm'</span>,<span class="st">'uma_locale'</span>,<span class="st">'uma_locale2'</span>,
                                                      <span class="st">'libelle_um'</span>,<span class="st">'service'</span>,<span class="st">'regroupement1'</span>,<span class="st">'pole'</span>),
                                        <span class="dt">skip =</span> <span class="dv">1</span>
)

dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/verif_structure.html">verif_structure</a></span>(rum,fichier_structure)
<span class="co">#&gt; </span>
<span class="co">#&gt; Toutes les UMA sont renseignées dans le fichier structure</span>

rum &lt;-<span class="st"> </span>rum <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>( ., fichier_structure ) <span class="op">%&gt;%</span>
<span class="st">           </span><span class="kw">mutate</span>(<span class="dt">pole =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(pole),<span class="st">'Erreurs'</span>,pole),
           <span class="dt">service =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(service),<span class="st">'Erreur service non renseigné'</span>,service))
<span class="co">#&gt; Joining, by = c("nofiness", "cdurm")</span></code></pre></div>
<p>On pourrait à cet endroit, vouloir également ajouter d’autres informations sur les RUM comme par exemple l’identité des patients.</p>
</div>
</div>
</div>
<div id="generation-des-tableaux-de-bord" class="section level1">
<h1 class="hasAnchor">
<a href="#generation-des-tableaux-de-bord" class="anchor"></a>Génération des tableaux de bord</h1>
<p>Deux types de tableaux de bord peuvent être générés (les exemples donnés ici ne sont accéssibles que sur l’intranet de l’APHP) : - des tableaux synthétiques permettant une vue de l’évolution temporelle d’un indicateur pour l’ensmeble de l’établissement ou du groupe hospitalier (ex : <a href="http://msi.sls.aphp.fr/tdb/index.php?_tbl=TableauDeBordGeneral&amp;_mois=07&amp;_annee=2019&amp;_type=mens">intranet aphp</a> ), des recettes avec une répartition par service (ex : [intranet aphp]<a href="http://msi.sls.aphp.fr/tdb/index.php?_tbl=TableauDeBordValorisation&amp;_mois=07&amp;_annee=2019&amp;_type=mens" class="uri">http://msi.sls.aphp.fr/tdb/index.php?_tbl=TableauDeBordValorisation&amp;_mois=07&amp;_annee=2019&amp;_type=mens</a>) - des tableaux détaillés pour chaque niveau du fichier structure permettant de suivre l’évolution temporalle pour ce niveau d’un ensemble d’indicateurs prédéfinis (ex <a href="http://msi.sls.aphp.fr/tdb/index.php?_tbl=TableauDeBordActivite&amp;_service=Lariboisiere&amp;_mois=07&amp;_annee=2019&amp;_type=mens">intranet aphp</a>).</p>
<p>Pour l’ensemble de ces tableaux on produit une version mensuelle et une version cumulée. La fonction <code><a href="../reference/get_data.html">get_data()</a></code> permet de préparer les données.</p>
<div id="parametres-des-tableaux-de-bord" class="section level3">
<h3 class="hasAnchor">
<a href="#parametres-des-tableaux-de-bord" class="anchor"></a>Paramètres des tableaux de bord</h3>
<p>Pour les tableaux détaillés, un fichier de paramétrage permet de définir quels indicateurs calculer pour chaque élément du fichier structure (par ex. le suivi de l’activité des services de réanimation nécessitera le suivi d’indicateurs différents que ceux des services de médecine). Sachant que le nombre d’indicateurs calculés aujourd’hui est important (de l’ordre de 200) nous avons également laisser la possibilité de découper les résultats en différents tableaux.</p>
<p>L’option <code>profondeur_tdb</code> permet de définir la profondeur temporelle, en année, du suivi des tableaux de bord. D’autres données de références sont également utiles commes les dms de référence dans la base nationale pmsi ou des liste de disgnostics. Elles sont chargées grâce aux package <code>referime```` et</code>referentiel```.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co">#Chemins pour les sorties écriture des fichiers de sortie</span>
path_res =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span>()

<span class="co">#Année et mois en cours</span>
mois=<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span>()<span class="op">-</span><span class="dv">50</span>,<span class="st">'%m'</span>));Mois=<span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span>()<span class="op">-</span><span class="dv">50</span>,<span class="st">'%m'</span>)
annee=<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span>()<span class="op">-</span><span class="dv">55</span>,<span class="st">'%Y'</span>))

<span class="co">#Profondeur de calcul</span>
profondeur_tdb =<span class="st"> </span><span class="dv">2</span>

#### Import des paramètres des tableaux 
ghm_dms_nationales&lt;-referime<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/referime/man/get_table.html">get_table</a></span>(<span class="st">"ghm_dms_nationales"</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attachement du package : 'magrittr'</span>
<span class="co">#&gt; The following object is masked from 'package:purrr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     set_names</span>
<span class="co">#&gt; The following object is masked from 'package:tidyr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     extract</span>
<span class="co">#&gt; ## Retrieving data from http://referime.aphp.fr/v0.2/ref/ghm_dms_nationales/json</span>

<span class="co">#Merge rsa, dms pour les cas ou la référence dans ghm_dms_nationales = ghs</span>
rsa_dms1&lt;-<span class="kw">inner_join</span>(rsa<span class="op">%&gt;%</span><span class="kw">unite</span>(<span class="st">"ghm"</span>,gpcmd,gptype,gpnum,gpcompx,<span class="dt">sep=</span><span class="st">""</span>)<span class="op">%&gt;%</span>
<span class="st">                       </span><span class="kw">rename</span>(<span class="dt">ghs =</span> noghs)<span class="op">%&gt;%</span>
<span class="st">                       </span><span class="kw">select</span>(nofiness,cle_rsa,ansor,anseqta,ghs,ghm),
                     ghm_dms_nationales<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(ghs<span class="op">!=</span><span class="st">""</span>))
<span class="co">#&gt; Joining, by = c("anseqta", "ghs", "ghm")</span>
<span class="co">#Merge rsa, dms pour les cas ou la référence dans ghm_dms_nationales = ghm</span>
rsa_dms2&lt;-<span class="kw">inner_join</span>(rsa<span class="op">%&gt;%</span><span class="kw">unite</span>(<span class="st">"ghm"</span>,gpcmd,gptype,gpnum,gpcompx,<span class="dt">sep=</span><span class="st">""</span>)<span class="op">%&gt;%</span>
<span class="st">                       </span><span class="kw">select</span>(nofiness,cle_rsa,ansor,anseqta,ghm),
                     ghm_dms_nationales<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(ghs<span class="op">==</span><span class="st">""</span>))
<span class="co">#&gt; Joining, by = c("anseqta", "ghm")</span>
rsa_dms&lt;-<span class="kw">bind_rows</span>(rsa_dms1<span class="op">%&gt;%</span><span class="kw">select</span>(nofiness,cle_rsa,ansor,dms_n),
                   rsa_dms2<span class="op">%&gt;%</span><span class="kw">select</span>(nofiness,cle_rsa,ansor,dms_n)
                   )
<span class="kw"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(rsa_dms1,rsa_dms2) 


#### Import des paramètres (liste des indicateurs à calculer pour chaque niveau du fichier structure)
references&lt;-<span class="kw"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">'indicateurs.xls'</span>,
                       <span class="dt">sep=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>,
                       <span class="dt">header=</span>F,<span class="dt">fill=</span>T,
                       <span class="dt">na.strings =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"NA"</span>,<span class="st">""</span>),<span class="dt">stringsAsFactor=</span>F,<span class="dt">fileEncoding =</span> <span class="st">'latin1'</span>)

<span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(references)&lt;-dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/prep_string.html">prep_string</a></span>(references[<span class="dv">1</span>,])
references&lt;-references[<span class="op">-</span><span class="dv">1</span>,]<span class="op">%&gt;%</span><span class="kw">as_tibble</span>(.)
<span class="co">#labels = df simple avec les légendes</span>
labels&lt;-<span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(references[<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span>(references<span class="op">$</span>var),<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'var'</span>,<span class="st">'libelle'</span>,<span class="st">'niv'</span>)])
<span class="kw"><a href="https://rdrr.io/r/base/row.names.html">row.names</a></span>(labels)&lt;-labels<span class="op">$</span>var
labels&lt;-labels[,<span class="op">-</span><span class="dv">1</span>]

<span class="co">#Présents dans fichiers structure, absent référentiels</span>
<span class="co">#dimRactivite:::prep_string(str)[!dimRactivite:::prep_string(str)%in%names(references)]</span>
<span class="co">#Présents référentiels, absents fichier structure</span>
<span class="co">#names(references)[!names(references)%in%c(dimRactivite:::prep_string(str),'tdb','niv','libelle','var','variable','dataframe','referentiel')]</span>


#####################################################################################################################
<span class="co">#Prération des données pour le suivi de l'activité de cancérologie</span>
#####################################################################################################################
cancer_diag &lt;-<span class="st"> </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/selection_cancer_diag.html">selection_cancer_diag</a></span>(diagnostics)
cancer_pat &lt;-<span class="st"> </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/selection_cancer_pat.html">selection_cancer_pat</a></span>(cancer_diag , vano<span class="op">%&gt;%</span><span class="kw">inner_join</span>(., rum<span class="op">%&gt;%</span><span class="kw">select</span>(nofiness,cle_rsa,ansor,nas)) <span class="op">%&gt;%</span>
<span class="st">                                     </span><span class="kw">select</span>( nas, noanon ) <span class="op">%&gt;%</span>
<span class="st">                                     </span><span class="kw">distinct</span>(nas,noanon))
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "nas"</span>
cancer_rsa &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">inner_join</a></span>(cancer_pat,
                                rsa<span class="op">%&gt;%</span><span class="kw">inner_join</span>(., vano<span class="op">%&gt;%</span><span class="kw">select</span>(nofiness,cle_rsa,ansor,noanon))<span class="op">%&gt;%</span>
<span class="st">                                  </span><span class="kw">select</span>(noanon,nofiness,cle_rsa,ansor, moissor, nas, dp, gpcmd, gptype, gpnum, gpcompx))<span class="op">%&gt;%</span>
<span class="st">  </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/attribution_type_M4.html">attribution_type_M4</a></span>(.)<span class="op">%&gt;%</span>
<span class="st">  </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/attribution_statut_nx_patient.html">attribution_statut_nx_patient</a></span>(.)
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "noanon"</span></code></pre></div>
</div>
<div id="generation-des-tableaux-de-bord-synthetiques" class="section level3">
<h3 class="hasAnchor">
<a href="#generation-des-tableaux-de-bord-synthetiques" class="anchor"></a>Génération des tableaux de bord synthétiques</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
df&lt;-dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/get_data.html">get_data</a></span>(<span class="kw">inner_join</span>(rum,rum_v), <span class="dt">a =</span>(annee<span class="op">-</span>profondeur_tdb)<span class="op">:</span>annee, <span class="dt">m =</span> <span class="dv">1</span><span class="op">:</span>mois )
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "norum", "cle_rsa", "ansor", "moissor")</span>


tdb &lt;-<span class="st"> </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/get_activite_sejours.html">get_activite_sejours</a></span>( df, structure )
path_file=<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'TableauDeBordGeneral'</span>,annee,stringr<span class="op">::</span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span>(mois,<span class="dv">2</span>,<span class="st">"left"</span>,<span class="st">"0"</span>),<span class="st">'cum.xls'</span>)  
<span class="kw"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>( tdb, <span class="dt">file=</span>path_file, <span class="dt">sep=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, <span class="dt">row.names=</span>T, <span class="dt">col.names=</span><span class="ot">NA</span>, <span class="dt">na=</span><span class="st">''</span> , <span class="dt">fileEncoding =</span> <span class="st">"utf-8"</span> )

tdb &lt;-<span class="st"> </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/get_activite_recettes.html">get_activite_recettes</a></span>( df, structure )
path_file=<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'TableauDeBordValorisation'</span>,annee,stringr<span class="op">::</span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span>(mois,<span class="dv">2</span>,<span class="st">"left"</span>,<span class="st">"0"</span>),<span class="st">'cum.xls'</span>)  
<span class="kw"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>( tdb, <span class="dt">file=</span>path_file, <span class="dt">sep=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, <span class="dt">row.names=</span>T, <span class="dt">col.names=</span><span class="ot">NA</span>, <span class="dt">na=</span><span class="st">''</span> , <span class="dt">fileEncoding =</span> <span class="st">"utf-8"</span> )


df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(moissor) <span class="op">==</span><span class="st"> </span>mois )

tdb &lt;-<span class="st"> </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/get_activite_sejours.html">get_activite_sejours</a></span>( df, structure )
path_file=<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'TableauDeBordGeneral'</span>,annee,stringr<span class="op">::</span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span>(mois,<span class="dv">2</span>,<span class="st">"left"</span>,<span class="st">"0"</span>),<span class="st">'mens.xls'</span>)  
<span class="kw"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>( tdb, <span class="dt">file=</span>path_file, <span class="dt">sep=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, <span class="dt">row.names=</span>T, <span class="dt">col.names=</span><span class="ot">NA</span>, <span class="dt">na=</span><span class="st">''</span> , <span class="dt">fileEncoding =</span> <span class="st">"utf-8"</span> )

tdb &lt;-<span class="st"> </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/get_activite_recettes.html">get_activite_recettes</a></span>( df, structure )
path_file=<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'TableauDeBordValorisation'</span>,annee,stringr<span class="op">::</span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span>(mois,<span class="dv">2</span>,<span class="st">"left"</span>,<span class="st">"0"</span>),<span class="st">'mens.xls'</span>)  
<span class="kw"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>( tdb, <span class="dt">file=</span>path_file, <span class="dt">sep=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, <span class="dt">row.names=</span>T, <span class="dt">col.names=</span><span class="ot">NA</span>, <span class="dt">na=</span><span class="st">''</span> , <span class="dt">fileEncoding =</span> <span class="st">"utf-8"</span> )</code></pre></div>
</div>
<div id="generation-des-tableaux-de-bord-detailles" class="section level3">
<h3 class="hasAnchor">
<a href="#generation-des-tableaux-de-bord-detailles" class="anchor"></a>Génération des tableaux de bord détaillés</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tdb&lt;-<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
#######################################################################################################################
<span class="co">#Tableaux de bords thématiques</span>
#######################################################################################################################
niveau =<span class="st"> "hopital"</span>
vals =<span class="st"> </span>fichier_structure<span class="op">%&gt;%</span><span class="kw">select</span>(<span class="op">!!</span>niveau)<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>()<span class="op">%&gt;%</span><span class="kw">flatten_chr</span>()

<span class="cf">for</span> (val <span class="cf">in</span> vals ){
  
  <span class="co">#tdb[[val]]&lt;-dimRactivite:::make_tdb( val, niveau, annee, mois )</span>
  
}


niveau =<span class="st"> "pole"</span>
vals =<span class="st"> </span>fichier_structure<span class="op">%&gt;%</span><span class="kw">select</span>(<span class="op">!!</span>niveau)<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>()<span class="op">%&gt;%</span><span class="kw">flatten_chr</span>()

<span class="cf">for</span> (val <span class="cf">in</span> vals ){
  
  <span class="co">#tdb[[val]]&lt;-dimRactivite:::make_tdb( val, niveau, annee, mois )</span>
  
}


<span class="co">#niveau = "service"</span>
vals =<span class="st"> </span>fichier_structure<span class="op">%&gt;%</span><span class="kw">select</span>(<span class="op">!!</span>niveau)<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>()<span class="op">%&gt;%</span><span class="kw">flatten_chr</span>()

<span class="cf">for</span> ( val <span class="cf">in</span> vals ){
  
<span class="co">#  tdb[[val]]&lt;-make_tdb( val, niveau, annee, mois )</span>
  
}</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#import-des-donnees-dans-r">Import des données dans R</a></li>
      <li><a href="#generation-des-tableaux-de-bord">Génération des tableaux de bord</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by DIM APHP.Nord.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9100.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
