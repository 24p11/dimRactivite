<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Import des archives GENSRA et génération de tableaux de bord • dimRactivite</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Import des archives GENSRA et génération de tableaux de bord">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dimRactivite</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/generation-tableaux-de-bord-pmsi.html">Import des archives GENSRA et génération de tableaux de bord</a>
    </li>
    <li>
      <a href="../articles/indicateurs.html">indicateurs</a>
    </li>
    <li>
      <a href="../articles/methodes.html">Méthodes</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Import des archives GENSRA et génération de tableaux de bord</h1>
            
      
      
      <div class="hidden name"><code>generation-tableaux-de-bord-pmsi.Rmd</code></div>

    </div>

    
    
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(pmeasyr)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyverse)
<span class="co">#&gt; ── Attaching packages ───────────────────────────────────────────────────────────────────────────────────────────────────────────── tidyverse 1.2.1 ──</span>
<span class="co">#&gt; ✔ ggplot2 3.2.1.9000     ✔ purrr   0.3.2     </span>
<span class="co">#&gt; ✔ tibble  2.1.3          ✔ dplyr   0.8.3     </span>
<span class="co">#&gt; ✔ tidyr   1.0.0          ✔ stringr 1.4.0     </span>
<span class="co">#&gt; ✔ readr   1.3.1          ✔ forcats 0.4.0</span>
<span class="co">#&gt; ── Conflicts ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──</span>
<span class="co">#&gt; ✖ dplyr::filter() masks stats::filter()</span>
<span class="co">#&gt; ✖ dplyr::lag()    masks stats::lag()</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span> (RCurl)
<span class="co">#&gt; Le chargement a nécessité le package : bitops</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attachement du package : 'RCurl'</span>
<span class="co">#&gt; The following object is masked from 'package:tidyr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     complete</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(jsonlite)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attachement du package : 'jsonlite'</span>
<span class="co">#&gt; The following object is masked from 'package:purrr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     flatten</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(referentiels)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(nomensland)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(readxl)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dimRactivite)</code></pre></div>
<p>Les fonctions d’imports et d’analyses sont construites sur le principe que chaque établissement produit tous les mois des fichiers de données de facturation mis en entrée du logiciel ATIH GENRSA utilisé pour transmettre les données PMSI aux tutelles. L’analyse de ces fichiers par GENRSA produit 2 types d’archives (.zip) le in (les fichiers d’entrée) et le out (fichiers préparés pour être envoyés). Le package généralise l’import des fichiers zippés en sortie de GENRSA (in et out) dans un environnement de travail R permettant l’analyse des données et la production de tableaux de bord automatiques.</p>
<div id="import-des-donnees-dans-r" class="section level1">
<h1 class="hasAnchor">
<a href="#import-des-donnees-dans-r" class="anchor"></a>Import des données dans R</h1>
<div id="parametre-des-imports" class="section level3">
<h3 class="hasAnchor">
<a href="#parametre-des-imports" class="anchor"></a>Paramètre des imports</h3>
<p>Le paramètres nécessaires pour les imports se trouvent dans un le fichier options.yaml (cf exemple) en particulier la variable <code>path</code> qui donne le chemin du dossier racine dans le quel se trouve les archives PMSI en sortie de GENRSA.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
dimRactivite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dimRactivite/man/update_options.html">update_options</a></span>(<span class="st">'options.yaml'</span>)

profondeur_imports =<span class="st"> </span><span class="dv">2</span></code></pre></div>
</div>
<div id="creation-des-fichiers--rdata-par-remontee" class="section level3">
<h3 class="hasAnchor">
<a href="#creation-des-fichiers--rdata-par-remontee" class="anchor"></a>Création des fichiers .RData par remontée</h3>
<div id="analyse-des-fichiers-en-fonction-de-leur-extentions-ext-imco--zip-et-verification-de-la-presence-des--rdata" class="section level4">
<h4 class="hasAnchor">
<a href="#analyse-des-fichiers-en-fonction-de-leur-extentions-ext-imco--zip-et-verification-de-la-presence-des--rdata" class="anchor"></a>Analyse des fichiers en fonction de leur extentions (ext imco + .zip) et vérification de la présence des .RData</h4>
<p>La première étape consiste à scanner le dossier contenant les archives afin de dresser la liste de remontées disponibles ce qui produit un tableaux de données référençant l’ensemble des informations utiles sur les archives et leur contenu. Ce tableau appelé <code>fichiers_genrsa</code> sera utilisé par les autres fonctions d’imports comme reférentiel pour décrire les données disponibles. Il est sauvegardé dans les options.</p>
<p>Les fichiers sont ensuite analysés afin de préparer la création (ou non) des fichiers .RData. On vérifie la présence dans les fichiers zippés en entrée et en sortie de GENRSA de l’ensemble des fichiers nécessaires à la facturation et à l’analyse de l’activité en lisant l’extension des fichiers de l’archive. La (sous) fonction <code>analyse_fichiers_remontees</code> produit un dataframe <code>remontees_dispo</code> de synthèse où pour chaque remontée on liste l’absence (0) ou la présence (1) des fichiers qui seront utilisés. Ce dataframe sera également utilisé pour les autres fonctions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">remontees_dispo &lt;-<span class="st"> </span>dimRactivite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dimRactivite/man/analyse_dossier_remontees.html">analyse_dossier_remontees</a></span>( <span class="dt">maj_dernier_mois =</span> <span class="ot">FALSE</span> )
<span class="co">#Voir la liste des fichiers RData non disponibles qui seront générés à l'étape suivante</span>
<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>( remontees_dispo <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>( RData <span class="op">!=</span><span class="st"> </span><span class="dv">1</span> ) )
<span class="co">#&gt; # A tibble: 0 x 13</span>
<span class="co">#&gt; # … with 13 variables: finess &lt;chr&gt;, annee &lt;chr&gt;, mois &lt;chr&gt;, rss &lt;dbl&gt;,</span>
<span class="co">#&gt; #   rsa &lt;dbl&gt;, tra &lt;dbl&gt;, ano &lt;dbl&gt;, ium &lt;dbl&gt;, diap &lt;dbl&gt;, porg &lt;dbl&gt;,</span>
<span class="co">#&gt; #   pie &lt;dbl&gt;, manquants &lt;dbl&gt;, RData &lt;dbl&gt;</span></code></pre></div>
</div>
<div id="creation-et-sauvegarde-des--rdata-de-remontee-si-manquant-et-mise-a-jour-de-la-liste-des-remontees-disponibles" class="section level4">
<h4 class="hasAnchor">
<a href="#creation-et-sauvegarde-des--rdata-de-remontee-si-manquant-et-mise-a-jour-de-la-liste-des-remontees-disponibles" class="anchor"></a>Création et sauvegarde des .RData de remontée (si manquant) et mise à jour de la liste des remontées disponibles</h4>
<p>La fonction <code>save_remontee</code> prend comme argument le tableau de synthèse des fichiers diponibles dans le dossier racine (<code>remontees_dispo</code>) et produit un fichier .RData pour chaque remontée, qui est enregisté dans le dossier racine. Pour être importée, une remontée doit comprendre le in et le out de GENRSA. Les fichiers indispensables sont le .rss et le .rsa. S’ils ne sont pas présents dans l’archive les autres fichiers servant à la facturation seront générés automatiquement (fichier vide). Les remontées pour lequelles un fichier .RData est disponible ne seront pas ré-importés.</p>
<p>Par défaut, l’option <code>option recent = TRUE</code> induit la création du .RData pour la dernière remontée disponible en forçant la variable .RData du tableau de données <code>remontees_dispo</code> à 0 (même si un fichier .RData est disponible pour cette remontée dans le dossier racine).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">remontees_dispo &lt;-<span class="st"> </span>dimRactivite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dimRactivite/man/save_remontees.html">save_remontees</a></span>( remontees_dispo )</code></pre></div>
</div>
</div>
<div id="import-dans-lenvironement-de-travail" class="section level3">
<h3 class="hasAnchor">
<a href="#import-dans-lenvironement-de-travail" class="anchor"></a>Import dans l’environement de travail</h3>
<div id="rum-rsa-ano-et-des-donnees-de-valorisation" class="section level4">
<h4 class="hasAnchor">
<a href="#rum-rsa-ano-et-des-donnees-de-valorisation" class="anchor"></a>RUM, RSA, ANO et des données de valorisation</h4>
<p>Les données peuvent ensuite être importées dans la mémoire de R. Par défaut on choisit le M12 des années antérieures et le dernier mois pour l’année en cours.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
sel_remontees_import&lt;-remontees_dispo<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(annee) <span class="op">&gt;</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(remontees_dispo<span class="op">$</span>annee) ) <span class="op">-</span><span class="st"> </span>profondeur_imports, RData <span class="op">==</span><span class="st"> </span><span class="dv">1</span> )<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>( <span class="dt">mois  =</span>  <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(mois) )<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>( finess, annee )<span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>( mois <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(mois) )</code></pre></div>
<p>Le df <code>sel_remontees_import</code> est passé en argument de la fonction <code>load_all()</code> qui permet le chargment des données. Le paramètre <code>extra = TRUE</code> permet de charger des tableaux de données complémentaires utiles pour l’analyse : - rsa_v_nonconsol et rum_v_nonconsol : données non consolidées à la date de la remontée pour l’année N-1 (vs M12 classiquement utilisées dans les analyses) - rsa_v_tarifsante, rum_v_tarifsante : données N valorisées avec les tarifs de l’année N-1</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dimRactivite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dimRactivite/man/load_RData.html">load_RData</a></span>( sel_remontees_import, <span class="dt">extra =</span> <span class="ot">TRUE</span>  )
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "nas", "norum", "ansor", "moissor")</span>
<span class="co">#&gt; Joining, by = c("cle_rsa", "nas", "ansor", "moissor")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "nas", "norum", "ansor", "moissor")</span>
<span class="co">#&gt; Joining, by = c("cle_rsa", "nas", "ansor", "moissor")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  Importés dans l'espace de travail : </span>
<span class="co">#&gt; annees : 2018/2019</span>
<span class="co">#&gt; rsa, rsa_v  : 254262 lignes </span>
<span class="co">#&gt; rum, rum_v :287080 lignes </span>
<span class="co">#&gt; rum_v et rsa_v tarifs_anterieurs importés</span>
<span class="co">#&gt; rum_v et rsa_v nonconsol non importés (fichier n-1 absent)</span></code></pre></div>
</div>
<div id="import-des-fichiers-mo-et-dmi" class="section level4">
<h4 class="hasAnchor">
<a href="#import-des-fichiers-mo-et-dmi" class="anchor"></a>Import des fichiers MO et DMI</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/load_med.html">load_med</a></span>( sel_remontees_import )
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_IN_00047_201812.zip</span>
<span class="co">#&gt; Taille    : 18 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : med.txt</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_OUT_00047_201812.zip</span>
<span class="co">#&gt; Taille    : 21 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : med, medatu</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_IN_00047_201908.zip</span>
<span class="co">#&gt; Taille    : 12 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : med.txt</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_OUT_00047_201908.zip</span>
<span class="co">#&gt; Taille    : 15 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : med, medatu</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_IN_00076_201812.zip</span>
<span class="co">#&gt; Taille    : 18 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : med.txt</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_OUT_00076_201812.zip</span>
<span class="co">#&gt; Taille    : 41 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : med, medatu</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_IN_00076_201908.zip</span>
<span class="co">#&gt; Taille    : 12 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : med.txt</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_OUT_00076_201908.zip</span>
<span class="co">#&gt; Taille    : 28 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : med, medatu</span>
<span class="kw"><a href="../reference/load_dmi.html">load_dmi</a></span>( sel_remontees_import )
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_IN_00047_201812.zip</span>
<span class="co">#&gt; Taille    : 18 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : dmi.txt</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_OUT_00047_201812.zip</span>
<span class="co">#&gt; Taille    : 21 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : dmip</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_IN_00047_201908.zip</span>
<span class="co">#&gt; Taille    : 12 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : dmi.txt</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_OUT_00047_201908.zip</span>
<span class="co">#&gt; Taille    : 15 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : dmip</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_IN_00076_201812.zip</span>
<span class="co">#&gt; Taille    : 18 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : dmi.txt</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_OUT_00076_201812.zip</span>
<span class="co">#&gt; Taille    : 41 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : dmip</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_IN_00076_201908.zip</span>
<span class="co">#&gt; Taille    : 12 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : dmi.txt</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dézippage de l'archive MCO_OUT_00076_201908.zip</span>
<span class="co">#&gt; Taille    : 28 Mo</span>
<span class="co">#&gt; Type      : </span>
<span class="co">#&gt; Finess    : </span>
<span class="co">#&gt; Période   :  M</span>
<span class="co">#&gt; Date prod : </span>
<span class="co">#&gt; Fichiers  : dmip</span></code></pre></div>
</div>
<div id="ajout-des-donnees-de-struture" class="section level4">
<h4 class="hasAnchor">
<a href="#ajout-des-donnees-de-struture" class="anchor"></a>Ajout des données de struture</h4>
<p>Différentes données complémentaires peuvent ensuite être ajoutées aux données PMSI standardisées. L’ajout d’élements descriptifs des uma (leur libellé, services et pôles de rattachement) sera probablement le plus important d’entre eux. L’ajout des structures se fait grâce à un fichier de paramètres <code>structure.xls</code> (cf exemple).</p>
<p>La fonction <code><a href="../reference/verif_structure.html">verif_structure()</a></code> permet de s’assurer que l’ensemble des uma présentes dans les fichiers GENRSA sont bien renseignées dans le fichier structure.</p>
<p>Il s’agit ici d’un exemple non réel.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">

<span class="co"># ajout des structures dans les rum</span>
structures &lt;-<span class="st"> </span>readxl<span class="op">::</span><span class="kw"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/options.html">getOption</a></span>(<span class="st">'dimRactivite.structures'</span>),
                                 <span class="dt">col_types =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>( <span class="st">"text"</span> , <span class="st">"text"</span> , <span class="st">"text"</span> , <span class="st">"text"</span>, <span class="st">"text"</span> ),
                                 <span class="dt">col_names =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'hopital'</span>,<span class="st">'cdurm'</span>,<span class="st">'libelle_um'</span>,<span class="st">'service'</span>,<span class="st">'pole'</span>),
                                 <span class="dt">skip =</span> <span class="dv">1</span>
)


<span class="co">#vérification que toutes les UMA sont bien renseignées dans le fichier structure</span>
<span class="co">#verif_structure(rum,fichier_structure)</span>

rum &lt;-<span class="st"> </span>rum <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">inner_join</span>( ., structures ) <span class="op">%&gt;%</span>
<span class="st">          </span><span class="kw">mutate</span>( <span class="dt">pole =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(pole), <span class="st">'Erreurs'</span>, pole ),
                  <span class="dt">service =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(service), <span class="st">'Erreur service non renseigné'</span>, service ) )
<span class="co">#&gt; Joining, by = "cdurm"</span></code></pre></div>
<p>On pourrait à cet endroit, vouloir également ajouter d’autres informations sur les RUM comme par exemple l’identité des patients.</p>
</div>
</div>
</div>
<div id="generation-des-tableaux-de-bord" class="section level1">
<h1 class="hasAnchor">
<a href="#generation-des-tableaux-de-bord" class="anchor"></a>Génération des tableaux de bord</h1>
<p>Deux types de tableaux de bord peuvent être générés (les exemples donnés ici ne sont accéssibles que sur l’intranet de l’APHP) : - des tableaux synthétiques permettant une vue de l’évolution temporelle d’un indicateur pour l’ensemble de l’établissement ou du groupe hospitalier (ex : <a href="http://msi.sls.aphp.fr/tdb/index.php?_tbl=TableauDeBordGeneral&amp;_mois=07&amp;_annee=2019&amp;_type=mens">intranet aphp</a> ), des recettes avec une répartition par service (ex : <a href="http://msi.sls.aphp.fr/tdb/index.php?_tbl=TableauDeBordValorisation&amp;_mois=07&amp;_annee=2019&amp;_type=mens">intranet aphp</a> ) - des tableaux détaillés pour chaque niveau du fichier structure permettant de suivre l’évolution temporelle pour ce niveau d’un ensemble d’indicateurs prédéfinis (ex <a href="http://msi.sls.aphp.fr/tdb/index.php?_tbl=TableauDeBordActivite&amp;_service=Lariboisiere&amp;_mois=07&amp;_annee=2019&amp;_type=mens">intranet aphp</a>).</p>
<p>Pour l’ensemble de ces tableaux on produit une version mensuelle et une version cumulée. La fonction <code><a href="../reference/get_data.html">get_data()</a></code> permet de préparer les données.</p>
<div id="parametres-des-tableaux-de-bord" class="section level3">
<h3 class="hasAnchor">
<a href="#parametres-des-tableaux-de-bord" class="anchor"></a>Paramètres des tableaux de bord</h3>
<p>Pour les tableaux détaillés, un fichier de paramétrage permet de définir quels indicateurs calculés pour chaque élément du fichier structure (par ex. le suivi de l’activité des services de réanimation nécessitera le suivi d’indicateurs différents que ceux des services de médecine). Sachant que le nombre d’indicateurs calculés aujourd’hui est important (de l’ordre de 200) nous avons également laisser la possibilité de découper les résultats en différents tableaux.</p>
<p>L’option <code>profondeur_tdb</code> permet de définir la profondeur temporelle, en année, du suivi des tableaux de bord. D’autres données de références sont également utiles commes les dms de référence dans la base nationale pmsi ou des listes de disgnostics. Elles sont chargées grâce aux package <code>referime</code> et <code>referentiel</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co">#Chemins pour les sorties écriture des fichiers de sortie</span>
path_res =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span>()

<span class="co">#Année et mois en cours</span>
mois=<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span>()<span class="op">-</span><span class="dv">50</span>,<span class="st">'%m'</span>));Mois=<span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span>()<span class="op">-</span><span class="dv">50</span>,<span class="st">'%m'</span>)
annee=<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span>()<span class="op">-</span><span class="dv">55</span>,<span class="st">'%Y'</span>))

<span class="co">#Profondeur de calcul</span>
profondeur_tdb =<span class="st"> </span><span class="dv">2</span>

<span class="co">#Tarifs MCO</span>
tarifs_mco_ghs &lt;-<span class="st"> </span>nomensland<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/nomensland/man/get_table.html">get_table</a></span>(<span class="st">"tarifs_mco_ghs"</span>)


#### Import des paramètres des tableaux 
ghm_dms_nationales&lt;-nomensland<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/nomensland/man/get_table.html">get_table</a></span>(<span class="st">"ghm_dms_nationales"</span>)

<span class="co">#Merge rsa, dms pour les cas ou la référence dans ghm_dms_nationales = ghs</span>
rsa_dms1&lt;-dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">inner_join</a></span>( rsa <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unite</span>(<span class="st">"ghm"</span>,gpcmd,gptype,gpnum,gpcompx,<span class="dt">sep=</span><span class="st">""</span>)<span class="op">%&gt;%</span>
<span class="st">                       </span><span class="kw">rename</span>( <span class="dt">ghs =</span> noghs )<span class="op">%&gt;%</span>
<span class="st">                       </span><span class="kw">select</span>( nofiness, cle_rsa, ansor, anseqta, ghs, ghm ),
                     ghm_dms_nationales<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(ghs<span class="op">!=</span><span class="st">""</span>))
<span class="co">#&gt; Joining, by = c("anseqta", "ghs", "ghm")</span>
<span class="co">#Merge rsa, dms pour les cas ou la référence dans ghm_dms_nationales = ghm</span>
rsa_dms2 &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">inner_join</a></span>( rsa <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unite</span>(<span class="st">"ghm"</span>, gpcmd, gptype, gpnum, gpcompx, <span class="dt">sep=</span><span class="st">""</span> )<span class="op">%&gt;%</span>
<span class="st">                       </span><span class="kw">select</span>( nofiness, cle_rsa, ansor, anseqta, ghm ),
                     ghm_dms_nationales <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>( ghs<span class="op">==</span><span class="st">""</span> ) )
<span class="co">#&gt; Joining, by = c("anseqta", "ghm")</span>
rsa_dms &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>( rsa_dms1 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>( nofiness, cle_rsa, ansor, dms_n ),
                   rsa_dms2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>( nofiness, cle_rsa, ansor, dms_n )
                   )
<span class="kw"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>( rsa_dms1, rsa_dms2 ) 


#### Import des paramètres (liste des indicateurs à calculer pour chaque niveau du fichier structure)
references&lt;-readxl<span class="op">::</span><span class="kw"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span>(<span class="st">'indicateurs.xlsx'</span>,<span class="dt">col_names =</span> F)
<span class="co">#&gt; New names:</span>
<span class="co">#&gt; * `` -&gt; ...1</span>
<span class="co">#&gt; * `` -&gt; ...2</span>
<span class="co">#&gt; * `` -&gt; ...3</span>
<span class="co">#&gt; * `` -&gt; ...4</span>
<span class="co">#&gt; * `` -&gt; ...5</span>
<span class="co">#&gt; * … and 17 more problems</span>
<span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(references)&lt;-<span class="kw"><a href="../reference/prep_string.html">prep_string</a></span>(references[<span class="dv">1</span>,])
references&lt;-references[<span class="op">-</span><span class="dv">1</span>,]<span class="op">%&gt;%</span><span class="kw">as_tibble</span>(.)
<span class="co">#labels = df simple avec les légendes</span>
labels&lt;-<span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(references[<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span>(references<span class="op">$</span>var),<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'var'</span>,<span class="st">'libelle'</span>,<span class="st">'niv'</span>)])
<span class="kw"><a href="https://rdrr.io/r/base/row.names.html">row.names</a></span>(labels)&lt;-labels<span class="op">$</span>var
labels&lt;-labels[,<span class="op">-</span><span class="dv">1</span>]

<span class="co">#Présents dans fichiers structure, absent référentiels</span>
<span class="co">#dimRactivite:::prep_string(str)[!dimRactivite:::prep_string(str)%in%names(references)]</span>
<span class="co">#Présents référentiels, absents fichier structure</span>
<span class="co">#names(references)[!names(references)%in%c(dimRactivite:::prep_string(str),'tdb','niv','libelle','var','variable','dataframe','referentiel')]</span>


#####################################################################################################################
<span class="co">#Prération des données pour le suivi de l'activité de cancérologie</span>
#####################################################################################################################
cancer_diag &lt;-<span class="st"> </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/selection_cancer_diag.html">selection_cancer_diag</a></span>(diagnostics)
cancer_pat &lt;-<span class="st"> </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/selection_cancer_pat.html">selection_cancer_pat</a></span>(cancer_diag , vano<span class="op">%&gt;%</span><span class="kw">inner_join</span>(., rum<span class="op">%&gt;%</span><span class="kw">select</span>(nofiness,cle_rsa,ansor,nas)) <span class="op">%&gt;%</span>
<span class="st">                                     </span><span class="kw">select</span>( nas, noanon ) <span class="op">%&gt;%</span>
<span class="st">                                     </span><span class="kw">distinct</span>(nas,noanon))
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "nas"</span>
cancer_rsa &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">inner_join</a></span>(cancer_pat,
                                rsa<span class="op">%&gt;%</span><span class="kw">inner_join</span>(., vano<span class="op">%&gt;%</span><span class="kw">select</span>(nofiness,cle_rsa,ansor,noanon))<span class="op">%&gt;%</span>
<span class="st">                                  </span><span class="kw">select</span>(noanon,nofiness,cle_rsa,ansor, moissor, nas, dp, gpcmd, gptype, gpnum, gpcompx))<span class="op">%&gt;%</span>
<span class="st">  </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/attribution_type_M4.html">attribution_type_M4</a></span>(.)<span class="op">%&gt;%</span>
<span class="st">  </span>dimRactivite<span class="op">:::</span><span class="kw"><a href="../reference/attribution_statut_nx_patient.html">attribution_statut_nx_patient</a></span>(.)
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "noanon"</span></code></pre></div>
</div>
<div id="generation-des-tableaux-de-bord-synthetiques" class="section level3">
<h3 class="hasAnchor">
<a href="#generation-des-tableaux-de-bord-synthetiques" class="anchor"></a>Génération des tableaux de bord synthétiques</h3>
<p>Les données sont tirées au sort pour réaliser des tableaux de bord exemples.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rum &lt;-<span class="st"> </span>rum<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(moissor)<span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>mois)<span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample_n</a></span>(.,<span class="dv">10000</span>,<span class="dt">replace =</span> <span class="ot">FALSE</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">


df&lt;-dimRactivite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dimRactivite/man/get_data.html">get_data</a></span>(<span class="kw">inner_join</span>(rum,rum_v), <span class="dt">a =</span>(annee<span class="op">-</span>profondeur_tdb)<span class="op">:</span>annee, <span class="dt">m =</span> <span class="dv">1</span><span class="op">:</span>mois )
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "norum", "cle_rsa", "ansor", "moissor")</span>


tdb &lt;-<span class="st"> </span>dimRactivite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dimRactivite/man/get_activite_sejours.html">get_activite_sejours</a></span>( df, structures )
path_file=<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'TableauDeBordGeneral'</span>,annee,stringr<span class="op">::</span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span>(mois,<span class="dv">2</span>,<span class="st">"left"</span>,<span class="st">"0"</span>),<span class="st">'cum.xls'</span>)  
<span class="kw"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>( tdb, <span class="dt">file=</span>path_file, <span class="dt">sep=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, <span class="dt">row.names=</span>T, <span class="dt">col.names=</span><span class="ot">NA</span>, <span class="dt">na=</span><span class="st">''</span> , <span class="dt">fileEncoding =</span> <span class="st">"utf-8"</span> )

tdb &lt;-<span class="st"> </span>dimRactivite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dimRactivite/man/get_activite_recettes.html">get_activite_recettes</a></span>( df, structures )
path_file=<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'TableauDeBordValorisation'</span>,annee,stringr<span class="op">::</span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span>(mois,<span class="dv">2</span>,<span class="st">"left"</span>,<span class="st">"0"</span>),<span class="st">'cum.xls'</span>)  
<span class="kw"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>( tdb, <span class="dt">file=</span>path_file, <span class="dt">sep=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, <span class="dt">row.names=</span>T, <span class="dt">col.names=</span><span class="ot">NA</span>, <span class="dt">na=</span><span class="st">''</span> , <span class="dt">fileEncoding =</span> <span class="st">"utf-8"</span> )


df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(moissor) <span class="op">==</span><span class="st"> </span>mois )

tdb &lt;-<span class="st"> </span>dimRactivite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dimRactivite/man/get_activite_sejours.html">get_activite_sejours</a></span>( df, structures )
path_file=<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'TableauDeBordGeneral'</span>,annee,stringr<span class="op">::</span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span>(mois,<span class="dv">2</span>,<span class="st">"left"</span>,<span class="st">"0"</span>),<span class="st">'mens.xls'</span>)  
<span class="kw"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>( tdb, <span class="dt">file=</span>path_file, <span class="dt">sep=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, <span class="dt">row.names=</span>T, <span class="dt">col.names=</span><span class="ot">NA</span>, <span class="dt">na=</span><span class="st">''</span> , <span class="dt">fileEncoding =</span> <span class="st">"utf-8"</span> )

tdb &lt;-<span class="st"> </span>dimRactivite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dimRactivite/man/get_activite_recettes.html">get_activite_recettes</a></span>( df, structures )
path_file=<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'TableauDeBordValorisation'</span>,annee,stringr<span class="op">::</span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span>(mois,<span class="dv">2</span>,<span class="st">"left"</span>,<span class="st">"0"</span>),<span class="st">'mens.xls'</span>)  
<span class="kw"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>( tdb, <span class="dt">file=</span>path_file, <span class="dt">sep=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, <span class="dt">row.names=</span>T, <span class="dt">col.names=</span><span class="ot">NA</span>, <span class="dt">na=</span><span class="st">''</span> , <span class="dt">fileEncoding =</span> <span class="st">"utf-8"</span> )</code></pre></div>
</div>
<div id="generation-des-tableaux-de-bord-detailles" class="section level3">
<h3 class="hasAnchor">
<a href="#generation-des-tableaux-de-bord-detailles" class="anchor"></a>Génération des tableaux de bord détaillés</h3>
<p>Un tableau par élément du fichier structure dont la génération fait appel au fichier <code>indicateurs.xlsx</code> mentionné dans la documentation du package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tdb&lt;-<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
#######################################################################################################################
<span class="co">#Tableaux de bords thématiques</span>
#######################################################################################################################

val =<span class="st"> "GH"</span>
tdb[[val]]&lt;-<span class="kw"><a href="../reference/make_tdb.html">make_tdb</a></span>( val , <span class="dt">niveau =</span> <span class="ot">NULL</span>, annee, mois )
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "norum", "cle_rsa", "ansor", "moissor")</span>
<span class="co">#&gt; Joining, by = c("cle_rsa", "moissor", "ansor", "anseqta", "nas")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "nbrum")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "nas"</span>
<span class="co">#&gt; Joining, by = c("noghs", "anseqta", "ghm")</span>
<span class="co">#&gt; [1] "GH TableauDeBordActivite"</span>
<span class="co">#&gt; [1] "GH TableauDeBordDIM"</span>
<span class="co">#&gt; [1] "GH TableauDeBordMedical"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; [1] "GH TableauDeBordCaseMix"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>


niveau =<span class="st"> "hopital"</span>
vals =<span class="st"> </span>structures<span class="op">%&gt;%</span><span class="kw">select</span>(<span class="op">!!</span>niveau)<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>()<span class="op">%&gt;%</span><span class="kw">flatten_chr</span>()

<span class="cf">for</span> (val <span class="cf">in</span> vals ){
  
  tdb[[val]]&lt;-dimRactivite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dimRactivite/man/make_tdb.html">make_tdb</a></span>( val, niveau, annee, mois )
  
}
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "norum", "cle_rsa", "ansor", "moissor")</span>
<span class="co">#&gt; Joining, by = c("cle_rsa", "moissor", "ansor", "anseqta", "nas")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "nbrum")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "nas"</span>
<span class="co">#&gt; Joining, by = c("noghs", "anseqta", "ghm")</span>
<span class="co">#&gt; [1] "Hôpital Galien TableauDeBordActivite"</span>
<span class="co">#&gt; [1] "Hôpital Galien TableauDeBordDIM"</span>
<span class="co">#&gt; [1] "Hôpital Galien TableauDeBordMedical"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; [1] "Hôpital Galien TableauDeBordCaseMix"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "norum", "cle_rsa", "ansor", "moissor")</span>
<span class="co">#&gt; Joining, by = c("cle_rsa", "moissor", "ansor", "anseqta", "nas")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "nbrum")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "nas"</span>
<span class="co">#&gt; Joining, by = c("noghs", "anseqta", "ghm")</span>
<span class="co">#&gt; [1] "Hôpital Hippocrate TableauDeBordActivite"</span>
<span class="co">#&gt; [1] "Hôpital Hippocrate TableauDeBordDIM"</span>
<span class="co">#&gt; [1] "Hôpital Hippocrate TableauDeBordMedical"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; [1] "Hôpital Hippocrate TableauDeBordCaseMix"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>


niveau =<span class="st"> "pole"</span>
vals =<span class="st"> </span>structures<span class="op">%&gt;%</span><span class="kw">select</span>(<span class="op">!!</span>niveau)<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>()<span class="op">%&gt;%</span><span class="kw">flatten_chr</span>()

<span class="cf">for</span> (val <span class="cf">in</span> vals ){
  
  tdb[[val]]&lt;-dimRactivite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dimRactivite/man/make_tdb.html">make_tdb</a></span>( val, niveau, annee, mois )
  
}
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "norum", "cle_rsa", "ansor", "moissor")</span>
<span class="co">#&gt; Joining, by = c("cle_rsa", "moissor", "ansor", "anseqta", "nas")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "nbrum")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "nas"</span>
<span class="co">#&gt; Joining, by = c("noghs", "anseqta", "ghm")</span>
<span class="co">#&gt; [1] "Chirurgie TableauDeBordActivite"</span>
<span class="co">#&gt; [1] "Chirurgie TableauDeBordDIM"</span>
<span class="co">#&gt; [1] "Chirurgie TableauDeBordMedical"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; [1] "Chirurgie TableauDeBordCaseMix"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "norum", "cle_rsa", "ansor", "moissor")</span>
<span class="co">#&gt; Joining, by = c("cle_rsa", "moissor", "ansor", "anseqta", "nas")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "nbrum")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "nas"</span>
<span class="co">#&gt; Joining, by = c("noghs", "anseqta", "ghm")</span>
<span class="co">#&gt; [1] "Médecine TableauDeBordActivite"</span>
<span class="co">#&gt; [1] "Médecine TableauDeBordDIM"</span>
<span class="co">#&gt; [1] "Médecine TableauDeBordMedical"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; [1] "Médecine TableauDeBordCaseMix"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "norum", "cle_rsa", "ansor", "moissor")</span>
<span class="co">#&gt; Joining, by = c("cle_rsa", "moissor", "ansor", "anseqta", "nas")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "nbrum")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "nas"</span>
<span class="co">#&gt; Joining, by = c("noghs", "anseqta", "ghm")</span>
<span class="co">#&gt; [1] "Urgences - Réanimation TableauDeBordActivite"</span>
<span class="co">#&gt; [1] "Urgences - Réanimation TableauDeBordDIM"</span>
<span class="co">#&gt; [1] "Urgences - Réanimation TableauDeBordMedical"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; [1] "Urgences - Réanimation TableauDeBordCaseMix"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>


<span class="co">#niveau = "service"</span>
vals =<span class="st"> </span>structures<span class="op">%&gt;%</span><span class="kw">select</span>(<span class="op">!!</span>niveau)<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>()<span class="op">%&gt;%</span><span class="kw">flatten_chr</span>()

<span class="cf">for</span> ( val <span class="cf">in</span> vals ){
  
  tdb[[val]]&lt;-dimRactivite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dimRactivite/man/make_tdb.html">make_tdb</a></span>( val, niveau, annee, mois )
  
}
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "norum", "cle_rsa", "ansor", "moissor")</span>
<span class="co">#&gt; Joining, by = c("cle_rsa", "moissor", "ansor", "anseqta", "nas")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "nbrum")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "nas"</span>
<span class="co">#&gt; Joining, by = c("noghs", "anseqta", "ghm")</span>
<span class="co">#&gt; [1] "Chirurgie TableauDeBordActivite"</span>
<span class="co">#&gt; [1] "Chirurgie TableauDeBordDIM"</span>
<span class="co">#&gt; [1] "Chirurgie TableauDeBordMedical"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; [1] "Chirurgie TableauDeBordCaseMix"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "norum", "cle_rsa", "ansor", "moissor")</span>
<span class="co">#&gt; Joining, by = c("cle_rsa", "moissor", "ansor", "anseqta", "nas")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "nbrum")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "nas"</span>
<span class="co">#&gt; Joining, by = c("noghs", "anseqta", "ghm")</span>
<span class="co">#&gt; [1] "Médecine TableauDeBordActivite"</span>
<span class="co">#&gt; [1] "Médecine TableauDeBordDIM"</span>
<span class="co">#&gt; [1] "Médecine TableauDeBordMedical"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; [1] "Médecine TableauDeBordCaseMix"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "norum", "cle_rsa", "ansor", "moissor")</span>
<span class="co">#&gt; Joining, by = c("cle_rsa", "moissor", "ansor", "anseqta", "nas")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "nbrum")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = "nas"</span>
<span class="co">#&gt; Joining, by = c("noghs", "anseqta", "ghm")</span>
<span class="co">#&gt; [1] "Urgences - Réanimation TableauDeBordActivite"</span>
<span class="co">#&gt; [1] "Urgences - Réanimation TableauDeBordDIM"</span>
<span class="co">#&gt; [1] "Urgences - Réanimation TableauDeBordMedical"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span>
<span class="co">#&gt; [1] "Urgences - Réanimation TableauDeBordCaseMix"</span>
<span class="co">#&gt; Adding missing grouping variables: `noanon`</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor", "moissor", "noanon")</span></code></pre></div>
</div>
<div id="autres-tableaux-de-bord" class="section level3">
<h3 class="hasAnchor">
<a href="#autres-tableaux-de-bord" class="anchor"></a>Autres tableaux de bord</h3>
<p>En complément de ces formats standards, on peut imaginer de nombreux autres besoins. Nous proposons ici une tentative d’analyse des écarts de recettes totales entre l’année N et l’année N-1 dans un tableau de bord spécifique reposant sur une décomposition en 4 parties de cette différence de recettes : - évolution des tarifs entre n et n-1 - modifications de répartition dans les niveau de sévérité au sein de chaque racine - évolution des recettes liées aux suppléments - évolution des recettes extrêmes hauts et extrêmes bas - le reste que nous avons appelé activité et rend compte principalement de l’évolution du nombre de séjours et du casemix racine de ghm</p>
<p>Ces écarts étant très différents entre les séjours très courts (0 et 1 nuit) et les séjours très longs, ces séjours ont été mis à part. Notre définition des séjours longs discutable est une durée de séjours &gt; dms dans la base nationale + 30j.</p>
<p>La procédure suivante permet la production d’un tableau synthétique sur l’ensemble du groupe hospitalier visant à explorer ces écarts :</p>
<ul>
<li>Nb séjours, différence et % de différence année N vs N-1</li>
<li>Recettes, différence et % de différence année N vs N-1</li>
<li>Différentiel des recettes N vs N-1 pour les</li>
<li>séjours dont la durée &lt; 2j,</li>
<li>séjours dont la durée &gt;=DMS+30</li>
<li>séjours dont la durée &gt;= 2 jours et &lt; DMS+30 Pour dont les séjours durée &gt;= 2 jours et &lt; DMS+30 on essaye de décomposer la différentiel de recettes N vs N-1 en sous-parties :</li>
<li>part liée à l’évolution N vs N-1 de la répartition en niveaux de sévérité au sein des racines : on applique pour l’année N le taux de répartition en niveaux de sévérité de chaque racine à l’année N-1, cela donne des recettes théoriques à niveau sévérité constant; la différence avec les recettes observées constitue la part attribuable à l’évolution de la répartition en niveaux de sévérité</li>
<li>part liée aux suppléments</li>
<li>part liée aux extrêmes haut et bas</li>
<li>le reste qui correspond théoriquement aux variations d’activé : nb séjours * casemix racine</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
### Préparation des référentiels pour permettre analyse des données avec tarifs identiques N et N-1
tarifs_ghs&lt;-nomensland<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/nomensland/man/get_table.html">get_table</a></span>( <span class="st">"tarifs_mco_ghs"</span> )

tarifs_ghs_n1&lt;-dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">full_join</a></span>(tarifs_ghs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>( anseqta, ghs,<span class="dt">.keep_all =</span> <span class="ot">TRUE</span> ) <span class="op">%&gt;%</span><span class="kw">select</span>( anseqta, ghs, tarif_base ),
                         tarifs_ghs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>( anseqta, ghs,<span class="dt">.keep_all =</span> <span class="ot">TRUE</span> ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">anseqta =</span> <span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(anseqta)<span class="op">-</span><span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>( anseqta, ghs, tarif_base ),
                         <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ghs"</span>,<span class="st">"anseqta"</span>),<span class="dt">suffix =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">''</span>,<span class="st">"_n_1"</span>)
)

tarifs_ghs_n1&lt;-tarifs_ghs_n1<span class="op">%&gt;%</span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">tarif_base_n_1 =</span> <span class="kw">if_else</span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(tarif_base_n_<span class="dv">1</span>),tarif_base,tarif_base_n_<span class="dv">1</span>))<span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>tarif_base)<span class="op">%&gt;%</span><span class="kw">rename</span>(<span class="dt">tarif_base =</span> tarif_base_n_<span class="dv">1</span> )

t_replace =<span class="st"> ", niveau 1|en ambulatoire|, très courte durée|, sans complication significative|, sans problème significatif"</span>

racines&lt;-tarifs_ghs<span class="op">%&gt;%</span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>( anseqta <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'2018'</span>,<span class="st">'2019'</span>) )<span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>( <span class="dt">racine =</span> <span class="kw"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(ghm,<span class="dv">1</span>,<span class="dv">5</span>) ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>( ghs ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span> (racine, <span class="dt">.keep_all =</span> T ) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>( <span class="dt">libelle =</span> libelle_ghm ) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>( <span class="dt">libelle =</span> <span class="kw">str_replace</span>(libelle, t_replace, <span class="st">''</span>) )<span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>( racine, libelle )



##Préparation des données
df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_data.html">get_data</a></span>( <span class="kw">inner_join</span>(rum,rum_v), <span class="dt">a =</span> (annee<span class="op">-</span><span class="dv">1</span>)<span class="op">:</span>annee, <span class="dt">m =</span> <span class="dv">1</span><span class="op">:</span>mois ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>( <span class="dt">ansor =</span> <span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(ansor))
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "norum", "cle_rsa", "ansor", "moissor")</span>

df &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>( df<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(typehosp <span class="op">==</span><span class="st"> "C"</span>),
                        rum_v_tarifsante <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>( ansor, nofiness, cle_rsa, nas, norum, valotime, valopmctmono, valopmctmonotime1, valopmctmonotime2 ), 
                        <span class="dt">suffix =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>( <span class="st">""</span>, <span class="st">"_tarifsante"</span> ),
                        <span class="dt">by =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"nofiness"</span>, <span class="st">"nas"</span>, <span class="st">"norum"</span>, <span class="st">"cle_rsa"</span>, <span class="st">"ansor"</span>) ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>( ., <span class="kw">inner_join</span>(rsa,rsa_v) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>( <span class="dt">rec_exbh =</span> rec_exh <span class="op">+</span><span class="st"> </span>rec_exb ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                      </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>( ansor, anseqta, nofiness, cle_rsa, nas, <span class="dt">ghs=</span>noghs, rec_totale, rec_base, rec_exbh, duree ) ) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(.,rsa_dms)
<span class="co">#&gt; Joining, by = c("cle_rsa", "moissor", "ansor", "anseqta", "nas")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "nas", "cle_rsa", "ansor")</span>
<span class="co">#&gt; Joining, by = c("nofiness", "cle_rsa", "ansor")</span>

df_n&lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(ansor) <span class="op">==</span><span class="st"> </span>annee )
df_n&lt;-<span class="st"> </span>df_n <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>( ., tarifs_ghs  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>( anseqta, ghs,<span class="dt">.keep_all =</span> <span class="ot">TRUE</span> ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(anseqta, ghs, tarif_base ) )
<span class="co">#&gt; Joining, by = c("anseqta", "ghs")</span>


df_n1&lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(ansor) <span class="op">==</span><span class="st"> </span>annee <span class="op">-</span><span class="dv">1</span> )
df_n1 &lt;-<span class="st"> </span>df_n1 <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>( ., tarifs_ghs_n1  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>( anseqta, ghs,<span class="dt">.keep_all =</span> <span class="ot">TRUE</span> ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(anseqta, ghs, tarif_base ) )
<span class="co">#&gt; Joining, by = c("anseqta", "ghs")</span>


df&lt;-<span class="kw">bind_rows</span>(df_n,df_n1)<span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>( <span class="dt">racine =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>( cdghm, <span class="dv">1</span>, <span class="dv">5</span>)) , 
                 <span class="dt">diff_t =</span> valopmctmonotime1 <span class="op">-</span><span class="st"> </span>valopmctmonotime1_tarifsante )

## Réalisation du tableau de bord

res&lt;-<span class="st"> </span>dimRactivite<span class="op">:::</span><span class="kw">get_tdb_detail_recettes</span>( df<span class="op">%&gt;%</span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(pole <span class="op">!=</span><span class="st"> "Erreurs"</span>) )
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="co">#&gt; Joining, by = "pivot"</span>
<span class="kw"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>(res,<span class="dt">sep=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>,<span class="dt">file =</span> <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/options.html">getOption</a></span>(<span class="st">'dimRactivite.path_tdb_files'</span>),
                                       <span class="st">"detail_diff_recettes"</span>,annee,stringr<span class="op">::</span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span>(mois,<span class="dv">2</span>,<span class="st">"left"</span>,<span class="st">"0"</span>),<span class="st">'.xls'</span>))</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#import-des-donnees-dans-r">Import des données dans R</a></li>
      <li><a href="#generation-des-tableaux-de-bord">Génération des tableaux de bord</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by DIM APHP.Nord.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9100.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
